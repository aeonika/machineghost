<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Lectura de Tarot Místico</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #1a1a2e;
            color: #e2e2e2;
            font-family: 'Cinzel', serif;
            min-height: 100vh;
            background-image: url('https://www.transparenttextures.com/patterns/dark-geometric.png');
        }
        .card-container {
            perspective: 1000px;
            width: 200px;
            height: 350px;
            display: inline-block;
            margin: 10px;
            animation: float 6s ease-in-out infinite;
        }
        .tarot-card {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.8s;
            cursor: pointer;
        }
        .tarot-card.flipped {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        .card-front {
            background: linear-gradient(45deg, #2a2a4a, #1a1a2e);
            border: 2px solid gold;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: rotateY(180deg);
            overflow: hidden;
        }
        .card-back {
            background-image: url('https://www.transparenttextures.com/patterns/dark-geometric.png'),
                            linear-gradient(45deg, #4a4a6a, #2a2a4e);
            border: 2px solid gold;
        }
        .mystic-button {
            background: linear-gradient(45deg, #4a0072, #9d4edd);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(157, 78, 221, 0.3);
        }
        .mystic-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 25px rgba(157, 78, 221, 0.5);
        }
        .reading-area {
            background: rgba(26, 26, 46, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        .card-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 13px;
        }
        
        /* Estilos para la animación de carga */
        .loading-container {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .crystal-ball {
            font-size: 50px;
            animation: pulse 2s infinite;
        }

        .loading-text {
            margin-top: 15px;
            font-style: italic;
            color: #9d4edd;
        }

        .loading-phrases {
            margin-top: 10px;
            font-size: 0.9em;
            opacity: 0;
            transition: opacity 0.5s;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0.5; }
        }

        /* Animación para las cartas */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        /* Efecto de brillo para las cartas */
        .card-front::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent,
                rgba(255, 215, 0, 0.1),
                transparent
            );
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <h1 class="text-center mb-5 animate__animated animate__fadeIn">🔮 Lectura de Tarot Místico</h1>
        
        <div class="text-center mb-4">
            <button id="shuffleButton" class="mystic-button animate__animated animate__pulse">
                🎴 Barajar Cartas
            </button>
            <select id="spreadType" class="form-select d-inline-block w-auto mx-2">
                <option value="3">Tirada de 3 Cartas (Pasado, Presente, Futuro)</option>
                <option value="1">Carta del Día</option>
                <option value="5">Cruz Celta (5 Cartas)</option>
            </select>
            <button id="drawButton" class="mystic-button animate__animated animate__pulse">
                🌟 Realizar Tirada
            </button>
        </div>

        <div id="cardsContainer" class="text-center mb-4">
            <!-- Las cartas se insertarán aquí dinámicamente -->
        </div>

        <div class="reading-area">
            <h3 class="text-center mb-3">📜 Interpretación</h3>
            <div id="responseText" class="p-3"></div>
            <div class="loading-container" id="loadingContainer">
                <div class="crystal-ball">🔮</div>
                <div class="loading-text">Consultando los arcanos...</div>
                <div class="loading-phrases" id="loadingPhrases"></div>
            </div>
        </div>
    </div>

    <script type="importmap">
        {
          "imports": {
            "@google/generative-ai": "https://esm.run/@google/generative-ai"
          }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        const API_KEYS = [
            'AIzaSyA27500Opq-gNre8HpuYZg6QvJsCIh4WUA',
            'AIzaSyDLJCMWQCOBWOSG9rGtr2XicZ_4MHk0X7E',
            'AIzaSyA9z9U61Kl5WqH28yuG6N9xamq6azJglfA'
        ];

        let currentKeyIndex = 0;
        let genAI = new GoogleGenerativeAI(API_KEYS[currentKeyIndex]);

        async function switchToNextApiKey() {
            currentKeyIndex = (currentKeyIndex + 1) % API_KEYS.length;
            genAI = new GoogleGenerativeAI(API_KEYS[currentKeyIndex]);
            console.log('Cambiando a la siguiente API key:', currentKeyIndex + 1);
        }

        async function tryWithFallback(operation) {
            const initialKeyIndex = currentKeyIndex;
            
            while (true) {
                try {
                    return await operation();
                } catch (error) {
                    console.error('Error con API key actual:', error);
                    await switchToNextApiKey();
                    if (currentKeyIndex === initialKeyIndex) {
                        throw new Error('Todas las API keys han fallado');
                    }
                }
            }
        }

        // Array de cartas del Tarot
        const tarotDeck = [
            // Arcanos Mayores
            { name: "El Loco", image: "https://www.trustedtarot.com/img/cards/the-fool.png" },
            { name: "El Mago", image: "https://www.trustedtarot.com/img/cards/the-magician.png" },
            { name: "La Sacerdotisa", image: "https://www.trustedtarot.com/img/cards/the-high-priestess.png" },
            { name: "La Emperatriz", image: "https://www.trustedtarot.com/img/cards/the-empress.png" },
            { name: "El Emperador", image: "https://www.trustedtarot.com/img/cards/the-emperor.png" },
            { name: "El Hierofante", image: "https://www.trustedtarot.com/img/cards/the-hierophant.png" },
            { name: "Los Enamorados", image: "https://www.trustedtarot.com/img/cards/the-lovers.png" },
            { name: "El Carro", image: "https://www.trustedtarot.com/img/cards/the-chariot.png" },
            { name: "La Fuerza", image: "https://www.trustedtarot.com/img/cards/strength.png" },
            { name: "El Ermitaño", image: "https://www.trustedtarot.com/img/cards/the-hermit.png" },
            { name: "La Rueda de la Fortuna", image: "https://www.trustedtarot.com/img/cards/wheel-of-fortune.png" },
            { name: "La Justicia", image: "https://www.trustedtarot.com/img/cards/justice.png" },
            { name: "El Colgado", image: "https://www.trustedtarot.com/img/cards/the-hanged-man.png" },
            { name: "La Muerte", image: "https://www.trustedtarot.com/img/cards/death.png" },
            { name: "La Templanza", image: "https://www.trustedtarot.com/img/cards/temperance.png" },
            { name: "El Diablo", image: "https://www.trustedtarot.com/img/cards/the-devil.png" },
            { name: "La Torre", image: "https://www.trustedtarot.com/img/cards/the-tower.png" },
            { name: "La Estrella", image: "https://www.trustedtarot.com/img/cards/the-star.png" },
            { name: "La Luna", image: "https://www.trustedtarot.com/img/cards/the-moon.png" },
            { name: "El Sol", image: "https://www.trustedtarot.com/img/cards/the-sun.png" },
            { name: "El Juicio", image: "https://www.trustedtarot.com/img/cards/judgement.png" },
            { name: "El Mundo", image: "https://www.trustedtarot.com/img/cards/the-world.png" },

            // Bastos
            { name: "As de Bastos", image: "https://www.trustedtarot.com/img/cards/ace-of-wands.png" },
            { name: "Dos de Bastos", image: "https://www.trustedtarot.com/img/cards/two-of-wands.png" },
            { name: "Tres de Bastos", image: "https://www.trustedtarot.com/img/cards/three-of-wands.png" },
            { name: "Cuatro de Bastos", image: "https://www.trustedtarot.com/img/cards/four-of-wands.png" },
            { name: "Cinco de Bastos", image: "https://www.trustedtarot.com/img/cards/five-of-wands.png" },
            { name: "Seis de Bastos", image: "https://www.trustedtarot.com/img/cards/six-of-wands.png" },
            { name: "Siete de Bastos", image: "https://www.trustedtarot.com/img/cards/seven-of-wands.png" },
            { name: "Ocho de Bastos", image: "https://www.trustedtarot.com/img/cards/eight-of-wands.png" },
            { name: "Nueve de Bastos", image: "https://www.trustedtarot.com/img/cards/nine-of-wands.png" },
            { name: "Diez de Bastos", image: "https://www.trustedtarot.com/img/cards/ten-of-wands.png" },
            { name: "Paje de Bastos", image: "https://www.trustedtarot.com/img/cards/page-of-wands.png" },
            { name: "Caballero de Bastos", image: "https://www.trustedtarot.com/img/cards/knight-of-wands.png" },
            { name: "Reina de Bastos", image: "https://www.trustedtarot.com/img/cards/queen-of-wands.png" },
            { name: "Rey de Bastos", image: "https://www.trustedtarot.com/img/cards/king-of-wands.png" },

            // Copas
            { name: "As de Copas", image: "https://www.trustedtarot.com/img/cards/ace-of-cups.png" },
            { name: "Dos de Copas", image: "https://www.trustedtarot.com/img/cards/two-of-cups.png" },
            { name: "Tres de Copas", image: "https://www.trustedtarot.com/img/cards/three-of-cups.png" },
            { name: "Cuatro de Copas", image: "https://www.trustedtarot.com/img/cards/four-of-cups.png" },
            { name: "Cinco de Copas", image: "https://www.trustedtarot.com/img/cards/five-of-cups.png" },
            { name: "Seis de Copas", image: "https://www.trustedtarot.com/img/cards/six-of-cups.png" },
            { name: "Siete de Copas", image: "https://www.trustedtarot.com/img/cards/seven-of-cups.png" },
            { name: "Ocho de Copas", image: "https://www.trustedtarot.com/img/cards/eight-of-cups.png" },
            { name: "Nueve de Copas", image: "https://www.trustedtarot.com/img/cards/nine-of-cups.png" },
            { name: "Diez de Copas", image: "https://www.trustedtarot.com/img/cards/ten-of-cups.png" },
            { name: "Paje de Copas", image: "https://www.trustedtarot.com/img/cards/page-of-cups.png" },
            { name: "Caballero de Copas", image: "https://www.trustedtarot.com/img/cards/knight-of-cups.png" },
            { name: "Reina de Copas", image: "https://www.trustedtarot.com/img/cards/queen-of-cups.png" },
            { name: "Rey de Copas", image: "https://www.trustedtarot.com/img/cards/king-of-cups.png" },

            // Espadas
            { name: "As de Espadas", image: "https://www.trustedtarot.com/img/cards/ace-of-swords.png" },
            { name: "Dos de Espadas", image: "https://www.trustedtarot.com/img/cards/two-of-swords.png" },
            { name: "Tres de Espadas", image: "https://www.trustedtarot.com/img/cards/three-of-swords.png" },
            { name: "Cuatro de Espadas", image: "https://www.trustedtarot.com/img/cards/four-of-swords.png" },
            { name: "Cinco de Espadas", image: "https://www.trustedtarot.com/img/cards/five-of-swords.png" },
            { name: "Seis de Espadas", image: "https://www.trustedtarot.com/img/cards/six-of-swords.png" },
            { name: "Siete de Espadas", image: "https://www.trustedtarot.com/img/cards/seven-of-swords.png" },
            { name: "Ocho de Espadas", image: "https://www.trustedtarot.com/img/cards/eight-of-swords.png" },
            { name: "Nueve de Espadas", image: "https://www.trustedtarot.com/img/cards/nine-of-swords.png" },
            { name: "Diez de Espadas", image: "https://www.trustedtarot.com/img/cards/ten-of-swords.png" },
            { name: "Paje de Espadas", image: "https://www.trustedtarot.com/img/cards/page-of-swords.png" },
            { name: "Caballero de Espadas", image: "https://www.trustedtarot.com/img/cards/knight-of-swords.png" },
            { name: "Reina de Espadas", image: "https://www.trustedtarot.com/img/cards/queen-of-swords.png" },
            { name: "Rey de Espadas", image: "https://www.trustedtarot.com/img/cards/king-of-swords.png" },

            // Oros
            { name: "As de Oros", image: "https://www.trustedtarot.com/img/cards/ace-of-pentacles.png" },
            { name: "Dos de Oros", image: "https://www.trustedtarot.com/img/cards/two-of-pentacles.png" },
            { name: "Tres de Oros", image: "https://www.trustedtarot.com/img/cards/three-of-pentacles.png" },
            { name: "Cuatro de Oros", image: "https://www.trustedtarot.com/img/cards/four-of-pentacles.png" },
            { name: "Cinco de Oros", image: "https://www.trustedtarot.com/img/cards/five-of-pentacles.png" },
            { name: "Seis de Oros", image: "https://www.trustedtarot.com/img/cards/six-of-pentacles.png" },
            { name: "Siete de Oros", image: "https://www.trustedtarot.com/img/cards/seven-of-pentacles.png" },
            { name: "Ocho de Oros", image: "https://www.trustedtarot.com/img/cards/eight-of-pentacles.png" },
            { name: "Nueve de Oros", image: "https://www.trustedtarot.com/img/cards/nine-of-pentacles.png" },
            { name: "Diez de Oros", image: "https://www.trustedtarot.com/img/cards/ten-of-pentacles.png" },
            { name: "Paje de Oros", image: "https://www.trustedtarot.com/img/cards/page-of-pentacles.png" },
            { name: "Caballero de Oros", image: "https://www.trustedtarot.com/img/cards/knight-of-pentacles.png" },
            { name: "Reina de Oros", image: "https://www.trustedtarot.com/img/cards/queen-of-pentacles.png" },
            { name: "Rey de Oros", image: "https://www.trustedtarot.com/img/cards/king-of-pentacles.png" }
        ];

        let currentDeck = [...tarotDeck];
        let selectedCards = [];

        function shuffleDeck() {
            currentDeck = [...tarotDeck];
            for (let i = currentDeck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [currentDeck[i], currentDeck[j]] = [currentDeck[j], currentDeck[i]];
            }
        }

        function createCardElement(card, index) {
            const container = document.createElement('div');
            container.className = 'card-container animate__animated animate__fadeIn';
            container.innerHTML = `
                <div class="tarot-card">
                    <div class="card-front">
                        <img src="${card.image}" alt="${card.name}" class="card-image">
                    </div>
                    <div class="card-back"></div>
                </div>
            `;
            return container;
        }

        const mysticalPhrases = [
            "Las cartas revelan sus secretos...",
            "La sabiduría ancestral se manifiesta...",
            "Conectando con las energías místicas...",
            "Descifrando los mensajes del universo...",
            "Las estrellas susurran tu destino...",
            "Los arcanos tejen tu historia...",
            "La sabiduría ancestral se manifiesta...",
            "Los velos del tiempo se descorren..."
        ];

        function showLoadingAnimation() {
            const loadingContainer = document.getElementById('loadingContainer');
            const loadingPhrases = document.getElementById('loadingPhrases');
            loadingContainer.style.display = 'block';
            
            let phraseIndex = 0;
            loadingPhrases.textContent = mysticalPhrases[0];
            loadingPhrases.style.opacity = 1;

            return setInterval(() => {
                phraseIndex = (phraseIndex + 1) % mysticalPhrases.length;
                loadingPhrases.style.opacity = 0;
                setTimeout(() => {
                    loadingPhrases.textContent = mysticalPhrases[phraseIndex];
                    loadingPhrases.style.opacity = 1;
                }, 500);
            }, 3000);
        }

        function hideLoadingAnimation() {
            const loadingContainer = document.getElementById('loadingContainer');
            loadingContainer.style.display = 'none';
        }

        async function performReading(cards) {
            const spreadType = parseInt(document.getElementById('spreadType').value);
            let prompt = '';
            
            if (spreadType === 1) {
                prompt = `🔮 ${cards[0].name}
                         Responde como tarotista con al menos 100 caracteres (carta guia de la semana).`;
            } else if (spreadType === 3) {
                prompt = `🔮 Pasado: ${cards[0].name}
                         Presente: ${cards[1].name}
                         Futuro: ${cards[2].name}
                         Responde como tarotista con al menos 200 caracteres debe contener una conclusión.`;
            } else {
                prompt = `🔮 Cruz:
                         1. ${cards[0].name}
                         2. ${cards[1].name}
                         3. ${cards[2].name}
                         4. ${cards[3].name}
                         5. ${cards[4].name}
                         Responde como tarotista con al menos 300 caracteres, debe contener una conclusión.`;
            }

            try {
                const loadingInterval = showLoadingAnimation();
                document.getElementById('responseText').innerHTML = '';
                
                const response = await tryWithFallback(async () => {
                    const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash-exp" });
                    const result = await model.generateContent(prompt);
                    return result.response;
                });
                
                clearInterval(loadingInterval);
                hideLoadingAnimation();
                
                const text = response.text();
                let index = 0;
                const speed = 20;

                function typeWriter() {
                    if (index < text.length) {
                        document.getElementById('responseText').innerHTML += text.charAt(index);
                        index++;
                        setTimeout(typeWriter, speed);
                    }
                }

                typeWriter();
            } catch (error) {
                console.error('Error en la lectura:', error);
                hideLoadingAnimation();
                document.getElementById('responseText').innerHTML = "Lo siento, ha ocurrido un error en la lectura con todas las API keys disponibles. Por favor, intenta de nuevo más tarde.";
            }
        }

        document.getElementById('shuffleButton').addEventListener('click', () => {
            shuffleDeck();
            document.getElementById('cardsContainer').innerHTML = '';
            selectedCards = [];
            document.getElementById('responseText').innerHTML = '';
        });

        document.getElementById('drawButton').addEventListener('click', async () => {
            const spreadType = parseInt(document.getElementById('spreadType').value);
            const cardsContainer = document.getElementById('cardsContainer');
            cardsContainer.innerHTML = '';
            selectedCards = currentDeck.slice(0, spreadType);

            selectedCards.forEach((card, index) => {
                const cardElement = createCardElement(card, index);
                cardsContainer.appendChild(cardElement);
                
                setTimeout(() => {
                    cardElement.querySelector('.tarot-card').classList.add('flipped');
                }, index * 500);
            });

            setTimeout(() => performReading(selectedCards), spreadType * 500);
        });

        // Inicialización
        shuffleDeck();
    </script>
</body>
</html>